# Training Configuration for Trash Detection System
# Cấu hình training cho Detection và Classification models

# Detection Model Configuration
detection:
  # Model settings
  model_name: "yolov8n.pt"  # yolov8n, yolov8s, yolov8m, yolov8l, yolov8x
  pretrained: true
  
  # Dataset
  data_yaml: "/home/huynguyen/source/Trash-Detection/data/processed/detection/dataset.yaml"
  
  # --- Training settings (OPTIMIZED FOR LOW mAP) ---
  epochs: 300             # tăng thêm epochs vì loss vẫn giảm được
  batch_size: 8           # giảm batch size để model học chi tiết hơn
  imgsz: 640              # giảm imgsz để tăng batch_size effective
  device: "cuda"          # chạy hoàn toàn trên GPU
  workers: 8              # tận dụng đa luồng I/O
  patience: 100           # tăng patience vì đang cải thiện chậm
  save_period: 5          # lưu thường xuyên hơn để theo dõi

  # --- Optimizer & LR (FIXED FOR LOW RECALL) ---
  optimizer: "SGD"        # SGD thường tốt hơn cho detection
  lr0: 0.01               # tăng learning rate cho SGD
  lrf: 0.001              # learning rate final thấp hơn
  weight_decay: 0.0005
  momentum: 0.937

  # --- Data split ---
  val_split: 0.1          # 10% dữ liệu dùng cho validation
  
  # --- Detection specific settings ---
  conf: 0.001             # confidence threshold thấp để detect nhiều object hơn
  iou: 0.6                # IoU threshold cao hơn để giảm duplicate
  max_det: 300            # tăng max detections per image
  
  # --- Loss weights (for hard examples) ---
  cls: 0.5                # class loss weight
  box: 7.5                # box regression loss weight (tăng để focus vào localization)
  dfl: 1.5                # distribution focal loss weight
  
  # --- Multi-scale training ---
  rect: false             # rectangular training (keep aspect ratio)
  multi_scale: true       # enable multi-scale training

  # --- Augmentations (REDUCED FOR BETTER LEARNING) ---
  hsv_h: 0.01             # giảm color augmentation
  hsv_s: 0.5              # giảm saturation changes
  hsv_v: 0.3              # giảm brightness changes
  degrees: 5.0            # giảm rotation để model học shape tốt hơn
  translate: 0.05         # giảm translation
  scale: 0.3              # giảm scale variation
  shear: 0.0              # tắt shear
  perspective: 0.0        # tắt perspective
  flipud: 0.0             # tắt flip up-down
  fliplr: 0.3             # giảm horizontal flip
  mosaic: 0.8             # giảm mosaic probability
  mixup: 0.0              # tắt mixup tạm thời
  copy_paste: 0.0         # tắt copy-paste tạm thời

  # --- Logging ---
  project: "runs/train"
  name: "yolov8-trash-gpu12gb"
  exist_ok: True
  
  # Output
  project_name: "trash_detection"
  experiment_name: "detection_v1"
  save_dir: "results/detection"

# Classification Model Configuration  
classification:
  # Model settings
  model_name: "yolov8n-cls.pt"  # yolov8n-cls, yolov8s-cls, yolov8m-cls, yolov8l-cls, yolov8x-cls
  pretrained: true
  
  # Dataset
  data_yaml: "data/processed/classification"
  
  # Training hyperparameters (optimized for CPU)
  epochs: 30  # Reduced for CPU training
  batch_size: 16  # Smaller batch size for CPU
  img_size: 224  # Keep standard classification size
  learning_rate: 0.001
  weight_decay: 0.0005
  momentum: 0.937
  
  # Augmentations
  hsv_h: 0.015
  hsv_s: 0.7
  hsv_v: 0.4
  degrees: 15.0
  translate: 0.1
  scale: 0.9
  shear: 0.0
  perspective: 0.0
  flipud: 0.0
  fliplr: 0.5
  auto_augment: "randaugment"
  erasing: 0.4
  
  # Training settings
  patience: 20
  save_period: 5
  device: "cpu"  # GPU not available, using CPU
  workers: 8
  
  # Optimizer
  optimizer: "AdamW"  # SGD, Adam, AdamW
  lr_decay: 0.01
  
  # Validation
  val_split: 0.1
  
  # Output
  project_name: "trash_classification"
  experiment_name: "classification_v1"
  save_dir: "results/classification"

# Pipeline Configuration
pipeline:
  # Model paths (will be set after training)
  detection_model_path: "models/detection/best.pt"
  classification_model_path: "models/classification/best.pt"
  
  # Detection settings
  detection_conf_threshold: 0.25
  detection_iou_threshold: 0.45
  detection_img_size: 640
  
  # Classification settings
  classification_img_size: 224
  classification_conf_threshold: 0.5
  
  # Threading settings
  max_workers: 4
  queue_size: 100
  
  # Performance optimization
  skip_classification_below: 0.3  # Skip classification for low-confidence detections
  batch_classification: true
  
  # Output settings
  save_results: true
  show_labels: true
  show_confidence: true
  line_thickness: 2

# Evaluation Configuration
evaluation:
  # Model paths
  detection_model_path: "models/detection/best.pt"
  classification_model_path: "models/classification/best.pt"
  
  # Dataset paths
  detection_data_yaml: "data/processed/detection/dataset.yaml"
  classification_data_yaml: "data/processed/classification"
  
  # Evaluation settings
  detection_conf_thresholds: [0.1, 0.25, 0.5, 0.75]
  detection_iou_threshold: 0.5
  classification_conf_threshold: 0.5
  
  # Output
  results_dir: "results/evaluation"
  experiment_name: "evaluation_v1"
  
  # Visualization
  save_plots: true
  show_plots: true

# Dataset Configuration
datasets:
  # TACO Dataset (Detection)
  taco:
    download_url: "http://tacodataset.org/files/TACO.zip"
    base_dir: "/home/huynguyen/source/Trash-Detection/data/raw"
    processed_dir: "/home/huynguyen/source/Trash-Detection/data/processed"
    
    # Class mapping (TACO -> Custom)
    class_mapping:
      # Có thể customize class mapping ở đây
      # VD: "Aluminium foil": "metal"
      
    # Data splits
    train_split: 0.6
    val_split: 0.1
    test_split: 0.3
    
    # Processing settings
    min_bbox_area: 100
    max_bbox_area: 100000
    
  # Garbage Dataset (Classification)
  trashnet:
    download_url: "https://github.com/garythung/trashnet/archive/master.zip"
    base_dir: "/home/huynguyen/source/Trash-Detection/data/raw"
    processed_dir: "/home/huynguyen/source/Trash-Detection/training-model/data/processed/classification"
    
    # Class mapping (TrashNet -> Custom)
    classes: ["cardboard", "glass", "metal", "paper", "plastic", "trash"]
    
    # Data splits
    train_split: 0.6
    val_split: 0.1
    test_split: 0.3
    
    # Processing settings
    img_size: [224, 224]
    quality: 95

# Hardware Configuration
hardware:
  # CPU-optimized settings (GPU not available)
  mixed_precision: false  # Disabled for CPU training
  
  # CPU settings
  num_workers: 4  # Reduced for CPU training
  pin_memory: false  # Disabled for CPU training
  
  # Batch size auto-scaling
  auto_batch_size: false  # Tự động tìm batch size tối ưu
  
# Logging and Monitoring
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  log_file: "training.log"
  
  # Tensorboard/Wandb integration
  use_tensorboard: false
  use_wandb: false
  wandb_project: "trash-detection"
  
  # Progress tracking
  log_frequency: 10  # Log every N epochs
  save_frequency: 20  # Save checkpoint every N epochs

# Paths Configuration
paths:
  # Base directories
  data_dir: "data"
  models_dir: "models" 
  results_dir: "results"
  logs_dir: "logs"
  
  # Pretrained models (sẽ tự động download nếu chưa có)
  pretrained_models:
    detection: "yolov8n.pt"
    classification: "yolov8n-cls.pt"